#!/bin/bash
# vim: set syntax=bash

set -euo pipefail
set -x

imageHome=/home/builder

usage() {
    echo "Usage: $(basename $0) [options] <image> <parameters to docker>"
    echo
    echo "Options:"
    echo "  -h, --home <home>: home directory in the image. Default: ${imageHome}"
    echo "  -r, --root: run as root"
    echo "  --cpus <number>: number of cpus to give to the docker process"
}

if (( $# < 1 ));
then
    usage
    exit 0
fi

user=""
cpus=3

while (( $# > 0 ));
do
    case "$1" in
    --home)
        shift
        imageHome=$1
        ;;
    -h|--help)
        usage
        exit 0
        ;;
    -r|--root)
        user="-u 0"
        imageHome=/root
        ;;
    --cpus)
        shift
        cpus=$1
        ;;
    *)
        image=$1
        shift
        break
        ;;
    esac
    shift
done

command=/bin/bash

if (( $# > 0));
then
    command=$*
fi

docker run --rm -it \
    ${user} \
    -v $(pwd):/workspace \
    -v ${HOME}/.npmrc:${imageHome}/.npmrc \
    -v ${HOME}/.ssh/id_ed25519:${imageHome}/.ssh/id_ed25519 \
    -v ${HOME}/.ssh/known_hosts:${imageHome}/.ssh/known_hosts \
    -v ${HOME}/.ssh/id_ed25519.pub:${imageHome}/.ssh/id_ed25519.pub \
    -v ${HOME}/configs/_ssh/config:${imageHome}/.ssh/config \
    -v ${HOME}/.config/pip/pip.conf:${imageHome}/.config/pip/pip.conf \
    -v ${HOME}/.gitconfig:${imageHome}/.gitconfig \
    --network host \
    --cpus="${cpus}" \
    ${image} \
    ${command}
