#!/bin/bash -x
# vim: set syntax bash

internalMonitor='eDP1'
externalMonitors='DP2-3 DP2-2 HDMI2'
autoConfigure=0

usageAndExit() {
    echo "$(basename $0)"
    echo
    echo "Options:"
    echo "\t--auto: auto-detect monitors and configure them"
    echo "\t--off : turn off external monitors"

    exit $1
}

turnOffExternalMonitors() {
    xrandr --output "$internalMonitor" --auto
    externalMonitors=$(xrandr | grep 'connected' | grep -v primary | awk '{print $1}')
    for monitor in $externalMonitors;
    do
        xrandr --output "$monitor" --off
    done
}

case "$1" in
-h|--help)
    usageAndExit 0
    ;;
--auto)
    autoConfigure=1
    ;;
--off)
    turnOffExternalMonitors
    ;;
esac

externalMonitors=$(xrandr | grep ' connected' | grep -v primary | awk '{print $1}')
externalMonitorCount=$(echo "$externalMonitors" | wc -w)

if (( $externalMonitorCount < 1 ));
then
    turnOffExternalMonitors
elif [[ $externalMonitorCount -lt 2 || $autoConfigure -eq 1 ]];
then
    previousMonitor="$internalMonitor"
    for monitor in $externalMonitors;
    do
        xrandr --output "$monitor" --auto --right-of "$previousMonitor"
        previousMonitor="$monitor"
    done

    xrandr --output "$previousMonitor" --primary
else
    leftMonitor='DP2-3'
    rightMonitor='DP2-2'
    xrandr --output "$internalMonitor" --off
    xrandr --output "$leftMonitor" --auto --primary
    xrandr --output "$rightMonitor" --auto --right-of "$leftMonitor"
fi

# reconfigure xmodmap
# when connecting the external keyboard linux needs to be told to remap the modmap
[[ -f ~/.Xmodmap_en ]] && xmodmap ~/.Xmodmap_en
[[ -f ~/.Xmodmap_language_independent ]] && xmodmap ~/.Xmodmap_language_independent

# reconfigure Ploopy
# swap 3 and 8
# 8 -> 2
xinput --set-button-map "Unknown Ploopy Trackball" 1 2 8 4 5 6 7 3 2
